@page "/admin/removeuser"
@inject ProtectedLocalStorage storage
@inject NavigationManager navigate
@inject ISnackbar snackbar

<h2>Remove user</h2>

<MudTextField @bind-Value="userID" Label="User ID" Variant="Variant.Outlined" id="textFieldColor" Style="@theme.textFieldColor"></MudTextField>
<MudButton @onclick="submitForm" Variant="Variant.Outlined" class="btncolor">submit</MudButton>


@code 
{
    Mongo mongo = new Mongo("college-site-2");
    Theme theme = new Theme();
    private static string userID { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var accountTypeCheck = await storage.GetAsync<string>("accountType");

            if (accountTypeCheck.Value != "Admin")
            {
                navigate.NavigateTo("/homepage");
            }
        }
        catch
        {
            navigate.NavigateTo("/homepage");
        }
    }




    private void submitForm()
    {
        try
        {
            bool validForm = true;

            //form validation
            if (userID == null || userID == "")
            {
                validForm = false;
            }


            bool sanityCheck = true;



            if (validForm && sanityCheck)
            {
                snackbar.Add("Processing, this may take a while, please wait", Severity.Info);
                var queryAllUserID = mongo.LoadRecordByString<AllUser>("allUser", "UserID", userID);
                var queryClasses = mongo.LoadRecord<Classes>("classes");

                foreach (var x in queryClasses)
                {
                    snackbar.Add("Processing, this may take a while, please wait", Severity.Info);
                    foreach (var y in x.Enrolled)
                    {
                        
                        if (y.UserID == userID)
                        {
                            y.UserID = "Removed User";
                        }
                    }
                }

                mongo.DeleteRecordById<AllUser>("allUser", queryAllUserID.Id);
                snackbar.Add("User was removed successfully", Severity.Success);
            }
            else
            {
                snackbar.Add("User was not removed successfully", Severity.Error);
            }
        }
        catch
        {
            snackbar.Add("User was not removed successfully", Severity.Error);
        }

    }

}
