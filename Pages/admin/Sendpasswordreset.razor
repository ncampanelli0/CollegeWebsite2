@page "/admin/sendpasswordreset"
@inject ProtectedLocalStorage storage
@inject NavigationManager navigate
@inject ISnackbar snackbar


<h2>Sendpasswordreset</h2>

<MudTextField @bind-Value="email" Label="Email" Variant="Variant.Outlined"></MudTextField>
<MudButton @onclick="submitForm" Variant="Variant.Outlined" Color="Color.Success">submit</MudButton>

@code 
{
    Mongo mongo = new Mongo("college-site-2");

    bool validForm = true;

    private static string? email { get; set; }

    private string genPassword()
    {
        var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        var stringChars = new char[8];
        var random = new Random();

        for (int i = 0; i < 8; i++)
        {
            stringChars.Append(chars[random.Next(chars.Length)]);
        }

        return stringChars.ToString();
    }

    private void submitForm()
    {
        if (email == null || email == "")
        {
            validForm = false;
        }

        if (validForm)
        {
            Mailtrap mail = new Mailtrap();
            var queryAllUser = mongo.LoadRecordByString<AllUser>("allUser", "Email", email);
            string newPassword = genPassword();



            queryAllUser.Password = newPassword;
            mongo.UpsertRecord<AllUser>("allUser", queryAllUser.Id, queryAllUser);
            mail.sendMail("Admin@clearwater.edu", email, "Password reset", $"new password: {newPassword}");
            snackbar.Add("Password reset was sent", Severity.Success);
        }
        else
        {
            snackbar.Add("Password reset was not sent", Severity.Error);
        }
    }
}
